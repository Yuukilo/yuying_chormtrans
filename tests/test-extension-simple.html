<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­å½±ç¿»è¯‘æ’ä»¶æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-text {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>è¯­å½±ç¿»è¯‘æ’ä»¶æµ‹è¯•é¡µé¢</h1>
    
    <div class="instructions">
        <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
        <ol>
            <li>ç¡®ä¿å·²åŠ è½½è¯­å½±ç¿»è¯‘æ’ä»¶</li>
            <li>ä½¿ç”¨å¿«æ·é”® Alt+T åˆ‡æ¢ç¿»è¯‘åŠŸèƒ½</li>
            <li>é€‰ä¸­ä¸‹æ–¹æ–‡æœ¬ï¼Œå³é”®é€‰æ‹©"ç¿»è¯‘é€‰ä¸­æ–‡æœ¬"</li>
            <li>ç‚¹å‡»æ’ä»¶å›¾æ ‡æ‰“å¼€è®¾ç½®é¢æ¿</li>
            <li>è§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>è‹±æ–‡æµ‹è¯•æ–‡æœ¬ï¼š</h3>
        <div class="test-text">
            Hello, this is a test text for the translation plugin. 
            The quick brown fox jumps over the lazy dog.
        </div>
    </div>

    <div class="test-section">
        <h3>ä¸­æ–‡æµ‹è¯•æ–‡æœ¬ï¼š</h3>
        <div class="test-text">
            ä½ å¥½ï¼Œè¿™æ˜¯ç¿»è¯‘æ’ä»¶çš„æµ‹è¯•æ–‡æœ¬ã€‚
            ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œé€‚åˆå‡ºå»æ•£æ­¥ã€‚
        </div>
    </div>

    <div class="test-section">
        <h3>æ—¥æ–‡æµ‹è¯•æ–‡æœ¬ï¼š</h3>
        <div class="test-text">
            ã“ã‚“ã«ã¡ã¯ã€ã“ã‚Œã¯ç¿»è¨³ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚
            ä»Šæ—¥ã¯ã¨ã¦ã‚‚è‰¯ã„å¤©æ°—ã§ã™ã­ã€‚
        </div>
    </div>

    <div class="test-section">
        <h3>æ³•æ–‡æµ‹è¯•æ–‡æœ¬ï¼š</h3>
        <div class="test-text">
            Bonjour, ceci est un texte de test pour le plugin de traduction.
            Il fait trÃ¨s beau aujourd'hui.
        </div>
    </div>

    <div id="status" class="status info">
        çŠ¶æ€ï¼šç­‰å¾…æ’ä»¶åŠ è½½...
    </div>

    <div id="installHelp" class="instructions" style="display: none; background-color: #fff3cd; border: 1px solid #ffeaa7;">
        <h3>ğŸš¨ æ‰©å±•æœªå®‰è£…æˆ–æœªå¯ç”¨</h3>
        <p><strong>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å®‰è£…æ‰©å±•ï¼š</strong></p>
        <ol>
            <li>ç¡®ä¿é¡¹ç›®å·²ç¼–è¯‘ï¼š<code>npm run dev</code></li>
            <li>æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè®¿é—® <code>chrome://extensions/</code></li>
            <li>å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"å¼€å…³</li>
            <li>ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"</li>
            <li>é€‰æ‹©é¡¹ç›®çš„ <code>dist</code> æ–‡ä»¶å¤¹</li>
            <li>ç¡®è®¤æ‰©å±•å·²å¯ç”¨å¹¶åˆ·æ–°æ­¤é¡µé¢</li>
        </ol>
        <p>
            <button onclick="openExtensionsPage()" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">æ‰“å¼€æ‰©å±•ç®¡ç†é¡µ</button>
            <button onclick="openInstallChecker()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">æ‰“å¼€å®‰è£…æ£€æŸ¥å™¨</button>
        </p>
    </div>

    <script src="test-extension-loading.js"></script>
    <script>
        console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
        
        // é¡µé¢çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const colors = {
                success: 'green',
                error: 'red',
                warning: 'orange',
                info: 'blue'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<br><span style="color: ${colors[type]};">[${timestamp}] ${message}</span>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        // æ˜¾ç¤ºå®‰è£…å¸®åŠ©
        function showInstallHelp() {
            document.getElementById('installHelp').style.display = 'block';
        }
        
        // æ‰“å¼€æ‰©å±•ç®¡ç†é¡µ
        function openExtensionsPage() {
            window.open('chrome://extensions/', '_blank');
        }
        
        // æ‰“å¼€å®‰è£…æ£€æŸ¥å™¨
        function openInstallChecker() {
            window.open('extension-install-checker.html', '_blank');
        }
        
        // æ£€æŸ¥æ‰©å±•åŸºç¡€åŠŸèƒ½
        async function checkExtensionBasics() {
            updateStatus('ğŸ”„ å¼€å§‹æ£€æŸ¥æ‰©å±•åŸºç¡€åŠŸèƒ½...', 'info');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                updateStatus('âœ… Chromeæ‰©å±•APIå¯ç”¨', 'success');
                
                // æ£€æŸ¥æ‰©å±•ID
                if (chrome.runtime.id) {
                    updateStatus(`âœ… æ‰©å±•å·²åŠ è½½ï¼ŒID: ${chrome.runtime.id}`, 'success');
                } else {
                    updateStatus('âŒ æ‰©å±•IDä¸å¯ç”¨', 'error');
                    showInstallHelp();
                    return false;
                }
                
                return true;
            } else {
                updateStatus('âŒ Chromeæ‰©å±•APIä¸å¯ç”¨', 'error');
                updateStatus('ğŸ’¡ è¿™é€šå¸¸è¡¨ç¤ºæ‰©å±•æœªå®‰è£…æˆ–é¡µé¢ä¸åœ¨Chromeæµè§ˆå™¨ä¸­æ‰“å¼€', 'warning');
                showInstallHelp();
                return false;
            }
        }
        
        // æµ‹è¯•æ‰©å±•é€šä¿¡
        async function testExtensionCommunication() {
            updateStatus('ğŸ”„ æµ‹è¯•æ‰©å±•é€šä¿¡...', 'info');
            
            return new Promise((resolve) => {
                chrome.runtime.sendMessage(
                    { type: 'GET_TRANSLATION_STATUS' },
                    function(response) {
                        if (chrome.runtime.lastError) {
                            updateStatus(`âŒ æ‰©å±•é€šä¿¡å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                            resolve(false);
                        } else if (response) {
                            updateStatus('âœ… æ‰©å±•é€šä¿¡æˆåŠŸ', 'success');
                            updateStatus(`ç¿»è¯‘çŠ¶æ€: ${response.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}`, 'info');
                            resolve(true);
                        } else {
                            updateStatus('âš ï¸ æ‰©å±•æ— å“åº”', 'warning');
                            resolve(false);
                        }
                    }
                );
                
                setTimeout(() => {
                    updateStatus('âŒ é€šä¿¡è¶…æ—¶', 'error');
                    resolve(false);
                }, 5000);
            });
        }
        
        // æµ‹è¯•è®¾ç½®è·å–
        async function testSettingsRetrieval() {
            updateStatus('ğŸ”„ æµ‹è¯•è®¾ç½®è·å–...', 'info');
            
            return new Promise((resolve) => {
                chrome.runtime.sendMessage(
                    { type: 'GET_SETTINGS' },
                    function(response) {
                        if (chrome.runtime.lastError) {
                            updateStatus(`âŒ è®¾ç½®è·å–å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                            resolve(false);
                        } else if (response && response.settings) {
                            updateStatus('âœ… è®¾ç½®è·å–æˆåŠŸ', 'success');
                            updateStatus(`APIæä¾›å•†: ${response.settings.apiProvider || 'æœªè®¾ç½®'}`, 'info');
                            updateStatus(`ç›®æ ‡è¯­è¨€: ${response.settings.targetLanguage || 'æœªè®¾ç½®'}`, 'info');
                            resolve(true);
                        } else {
                            updateStatus('âŒ è®¾ç½®è·å–å¤±è´¥ï¼Œæ— å“åº”', 'error');
                            resolve(false);
                        }
                    }
                );
                
                setTimeout(() => {
                    updateStatus('âŒ è®¾ç½®è·å–è¶…æ—¶', 'error');
                    resolve(false);
                }, 5000);
            });
        }
        
        // æ£€æŸ¥content scriptæ³¨å…¥
        function checkContentScript() {
            updateStatus('ğŸ”„ æ£€æŸ¥Content Scriptæ³¨å…¥...', 'info');
            
            // æ£€æŸ¥é¡µé¢é€‰æ‹©åŠŸèƒ½
            document.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    updateStatus(`ğŸ“ æ£€æµ‹åˆ°æ–‡æœ¬é€‰æ‹©: "${selection.toString().trim()}"`, 'info');
                    updateStatus('âœ… Content ScriptåŠŸèƒ½æ­£å¸¸', 'success');
                }
            });
            
            updateStatus('âœ… Content Scriptç›‘å¬å™¨å·²è®¾ç½®', 'success');
        }
        
        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runCompleteTest() {
            updateStatus('=== å¼€å§‹å®Œæ•´æ‰©å±•æµ‹è¯• ===', 'info');
            
            try {
                // 1. åŸºç¡€æ£€æŸ¥
                const basicsOk = await checkExtensionBasics();
                if (!basicsOk) {
                    updateStatus('âŒ åŸºç¡€æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢æµ‹è¯•', 'error');
                    return;
                }
                
                // 2. é€šä¿¡æµ‹è¯•
                const commOk = await testExtensionCommunication();
                if (!commOk) {
                    updateStatus('âš ï¸ é€šä¿¡æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å…¶ä»–æµ‹è¯•', 'warning');
                }
                
                // 3. è®¾ç½®æµ‹è¯•
                const settingsOk = await testSettingsRetrieval();
                if (!settingsOk) {
                    updateStatus('âš ï¸ è®¾ç½®æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å…¶ä»–æµ‹è¯•', 'warning');
                }
                
                // 4. Content Scriptæ£€æŸ¥
                checkContentScript();
                
                updateStatus('=== æµ‹è¯•å®Œæˆ ===', 'info');
                updateStatus(`åŸºç¡€åŠŸèƒ½: ${basicsOk ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, basicsOk ? 'success' : 'error');
                updateStatus(`é€šä¿¡åŠŸèƒ½: ${commOk ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, commOk ? 'success' : 'error');
                updateStatus(`è®¾ç½®åŠŸèƒ½: ${settingsOk ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, settingsOk ? 'success' : 'error');
                
            } catch (error) {
                updateStatus(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'success');
            updateStatus('â³ ç­‰å¾…æ‰©å±•åˆå§‹åŒ–...', 'info');
            
            // ç­‰å¾…æ‰©å±•åˆå§‹åŒ–
            setTimeout(() => {
                runCompleteTest();
            }, 2000);
        });
    </script>
</body>
</html>