<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语影翻译插件测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-text {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>语影翻译插件测试页面</h1>
    
    <div class="instructions">
        <h3>测试说明：</h3>
        <ol>
            <li>确保已加载语影翻译插件</li>
            <li>使用快捷键 Alt+T 切换翻译功能</li>
            <li>选中下方文本，右键选择"翻译选中文本"</li>
            <li>点击插件图标打开设置面板</li>
            <li>观察控制台是否有错误信息</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>英文测试文本：</h3>
        <div class="test-text">
            Hello, this is a test text for the translation plugin. 
            The quick brown fox jumps over the lazy dog.
        </div>
    </div>

    <div class="test-section">
        <h3>中文测试文本：</h3>
        <div class="test-text">
            你好，这是翻译插件的测试文本。
            今天天气很好，适合出去散步。
        </div>
    </div>

    <div class="test-section">
        <h3>日文测试文本：</h3>
        <div class="test-text">
            こんにちは、これは翻訳プラグインのテストテキストです。
            今日はとても良い天気ですね。
        </div>
    </div>

    <div class="test-section">
        <h3>法文测试文本：</h3>
        <div class="test-text">
            Bonjour, ceci est un texte de test pour le plugin de traduction.
            Il fait très beau aujourd'hui.
        </div>
    </div>

    <div id="status" class="status info">
        状态：等待插件加载...
    </div>

    <div id="installHelp" class="instructions" style="display: none; background-color: #fff3cd; border: 1px solid #ffeaa7;">
        <h3>🚨 扩展未安装或未启用</h3>
        <p><strong>请按以下步骤安装扩展：</strong></p>
        <ol>
            <li>确保项目已编译：<code>npm run dev</code></li>
            <li>打开Chrome浏览器，访问 <code>chrome://extensions/</code></li>
            <li>开启右上角的"开发者模式"开关</li>
            <li>点击"加载已解压的扩展程序"</li>
            <li>选择项目的 <code>dist</code> 文件夹</li>
            <li>确认扩展已启用并刷新此页面</li>
        </ol>
        <p>
            <button onclick="openExtensionsPage()" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">打开扩展管理页</button>
            <button onclick="openInstallChecker()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">打开安装检查器</button>
        </p>
    </div>

    <script src="test-extension-loading.js"></script>
    <script>
        console.log('测试页面已加载');
        
        // 页面状态显示
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const colors = {
                success: 'green',
                error: 'red',
                warning: 'orange',
                info: 'blue'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<br><span style="color: ${colors[type]};">[${timestamp}] ${message}</span>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        // 显示安装帮助
        function showInstallHelp() {
            document.getElementById('installHelp').style.display = 'block';
        }
        
        // 打开扩展管理页
        function openExtensionsPage() {
            window.open('chrome://extensions/', '_blank');
        }
        
        // 打开安装检查器
        function openInstallChecker() {
            window.open('extension-install-checker.html', '_blank');
        }
        
        // 检查扩展基础功能
        async function checkExtensionBasics() {
            updateStatus('🔄 开始检查扩展基础功能...', 'info');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                updateStatus('✅ Chrome扩展API可用', 'success');
                
                // 检查扩展ID
                if (chrome.runtime.id) {
                    updateStatus(`✅ 扩展已加载，ID: ${chrome.runtime.id}`, 'success');
                } else {
                    updateStatus('❌ 扩展ID不可用', 'error');
                    showInstallHelp();
                    return false;
                }
                
                return true;
            } else {
                updateStatus('❌ Chrome扩展API不可用', 'error');
                updateStatus('💡 这通常表示扩展未安装或页面不在Chrome浏览器中打开', 'warning');
                showInstallHelp();
                return false;
            }
        }
        
        // 测试扩展通信
        async function testExtensionCommunication() {
            updateStatus('🔄 测试扩展通信...', 'info');
            
            return new Promise((resolve) => {
                chrome.runtime.sendMessage(
                    { type: 'GET_TRANSLATION_STATUS' },
                    function(response) {
                        if (chrome.runtime.lastError) {
                            updateStatus(`❌ 扩展通信失败: ${chrome.runtime.lastError.message}`, 'error');
                            resolve(false);
                        } else if (response) {
                            updateStatus('✅ 扩展通信成功', 'success');
                            updateStatus(`翻译状态: ${response.enabled ? '已启用' : '未启用'}`, 'info');
                            resolve(true);
                        } else {
                            updateStatus('⚠️ 扩展无响应', 'warning');
                            resolve(false);
                        }
                    }
                );
                
                setTimeout(() => {
                    updateStatus('❌ 通信超时', 'error');
                    resolve(false);
                }, 5000);
            });
        }
        
        // 测试设置获取
        async function testSettingsRetrieval() {
            updateStatus('🔄 测试设置获取...', 'info');
            
            return new Promise((resolve) => {
                chrome.runtime.sendMessage(
                    { type: 'GET_SETTINGS' },
                    function(response) {
                        if (chrome.runtime.lastError) {
                            updateStatus(`❌ 设置获取失败: ${chrome.runtime.lastError.message}`, 'error');
                            resolve(false);
                        } else if (response && response.settings) {
                            updateStatus('✅ 设置获取成功', 'success');
                            updateStatus(`API提供商: ${response.settings.apiProvider || '未设置'}`, 'info');
                            updateStatus(`目标语言: ${response.settings.targetLanguage || '未设置'}`, 'info');
                            resolve(true);
                        } else {
                            updateStatus('❌ 设置获取失败，无响应', 'error');
                            resolve(false);
                        }
                    }
                );
                
                setTimeout(() => {
                    updateStatus('❌ 设置获取超时', 'error');
                    resolve(false);
                }, 5000);
            });
        }
        
        // 检查content script注入
        function checkContentScript() {
            updateStatus('🔄 检查Content Script注入...', 'info');
            
            // 检查页面选择功能
            document.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                if (selection.toString().trim()) {
                    updateStatus(`📝 检测到文本选择: "${selection.toString().trim()}"`, 'info');
                    updateStatus('✅ Content Script功能正常', 'success');
                }
            });
            
            updateStatus('✅ Content Script监听器已设置', 'success');
        }
        
        // 运行完整测试
        async function runCompleteTest() {
            updateStatus('=== 开始完整扩展测试 ===', 'info');
            
            try {
                // 1. 基础检查
                const basicsOk = await checkExtensionBasics();
                if (!basicsOk) {
                    updateStatus('❌ 基础检查失败，停止测试', 'error');
                    return;
                }
                
                // 2. 通信测试
                const commOk = await testExtensionCommunication();
                if (!commOk) {
                    updateStatus('⚠️ 通信测试失败，但继续其他测试', 'warning');
                }
                
                // 3. 设置测试
                const settingsOk = await testSettingsRetrieval();
                if (!settingsOk) {
                    updateStatus('⚠️ 设置测试失败，但继续其他测试', 'warning');
                }
                
                // 4. Content Script检查
                checkContentScript();
                
                updateStatus('=== 测试完成 ===', 'info');
                updateStatus(`基础功能: ${basicsOk ? '✅ 正常' : '❌ 异常'}`, basicsOk ? 'success' : 'error');
                updateStatus(`通信功能: ${commOk ? '✅ 正常' : '❌ 异常'}`, commOk ? 'success' : 'error');
                updateStatus(`设置功能: ${settingsOk ? '✅ 正常' : '❌ 异常'}`, settingsOk ? 'success' : 'error');
                
            } catch (error) {
                updateStatus(`❌ 测试过程中发生错误: ${error.message}`, 'error');
                console.error('测试错误:', error);
            }
        }
        
        // 页面加载完成后执行检查
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('📄 页面加载完成', 'success');
            updateStatus('⏳ 等待扩展初始化...', 'info');
            
            // 等待扩展初始化
            setTimeout(() => {
                runCompleteTest();
            }, 2000);
        });
    </script>
</body>
</html>