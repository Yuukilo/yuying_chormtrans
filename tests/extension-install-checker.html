<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语影翻译扩展安装检查器</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .check-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .check-item.success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .check-item.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .check-item.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .check-item.info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .icon {
            font-size: 24px;
            margin-right: 15px;
            min-width: 30px;
        }
        .install-steps {
            background-color: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .install-steps h3 {
            color: #0066cc;
            margin-top: 0;
        }
        .install-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .install-steps li {
            margin: 8px 0;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.secondary {
            background-color: #6c757d;
        }
        .button.secondary:hover {
            background-color: #545b62;
        }
        .code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #e83e8c;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 语影翻译扩展安装检查器</h1>
            <p>快速诊断扩展安装状态并获取解决方案</p>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="checkResults">
            <!-- 检查结果将在这里显示 -->
        </div>

        <div class="install-steps" id="installGuide" style="display: none;">
            <h3>📦 扩展安装步骤</h3>
            <ol>
                <li>确保项目已编译：在项目目录运行 <span class="code">npm run dev</span></li>
                <li>打开Chrome浏览器，访问 <span class="code">chrome://extensions/</span></li>
                <li>开启右上角的"开发者模式"开关</li>
                <li>点击"加载已解压的扩展程序"按钮</li>
                <li>选择项目的 <span class="code">dist</span> 文件夹</li>
                <li>确认扩展出现在扩展列表中且已启用</li>
            </ol>
            <p><strong>注意：</strong>如果看到错误信息，请检查dist目录是否包含所有必需文件。</p>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="button" onclick="runDiagnostic()">🔄 重新检查</button>
            <button class="button secondary" onclick="openExtensionsPage()">🔧 打开扩展管理页</button>
            <button class="button secondary" onclick="openTestPage()">🧪 打开测试页面</button>
        </div>
    </div>

    <script>
        let checkProgress = 0;
        const totalChecks = 6;

        function updateProgress() {
            checkProgress++;
            const percentage = (checkProgress / totalChecks) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function addCheckResult(icon, message, type, details = '') {
            const resultsDiv = document.getElementById('checkResults');
            const checkItem = document.createElement('div');
            checkItem.className = `check-item ${type}`;
            checkItem.innerHTML = `
                <span class="icon">${icon}</span>
                <div>
                    <strong>${message}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
            resultsDiv.appendChild(checkItem);
            updateProgress();
        }

        async function runDiagnostic() {
            // 重置检查状态
            checkProgress = 0;
            document.getElementById('checkResults').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('installGuide').style.display = 'none';

            let hasErrors = false;

            // 检查1: Chrome扩展API
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                addCheckResult('✅', 'Chrome扩展API可用', 'success', '浏览器支持扩展开发');
            } else {
                addCheckResult('❌', 'Chrome扩展API不可用', 'error', '请在Chrome浏览器中打开此页面');
                hasErrors = true;
            }

            // 检查2: 扩展运行时
            if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                addCheckResult('✅', '扩展已加载', 'success', `扩展ID: ${chrome.runtime.id}`);
            } else {
                addCheckResult('❌', '扩展未加载', 'error', '扩展可能未安装或未启用');
                hasErrors = true;
            }

            // 检查3: 扩展通信
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    const response = await new Promise((resolve, reject) => {
                        chrome.runtime.sendMessage({ type: 'ping' }, (response) => {
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve(response);
                            }
                        });
                        setTimeout(() => reject(new Error('超时')), 3000);
                    });
                    
                    if (response && response.status === 'pong') {
                        addCheckResult('✅', '扩展通信正常', 'success', 'Background script响应正常');
                    } else {
                        addCheckResult('⚠️', '扩展通信异常', 'warning', '收到意外响应');
                    }
                } catch (error) {
                    addCheckResult('❌', '扩展通信失败', 'error', `错误: ${error.message}`);
                    hasErrors = true;
                }
            } else {
                addCheckResult('❌', '无法测试扩展通信', 'error', '扩展API不可用');
                hasErrors = true;
            }

            // 检查4: 扩展设置
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    const response = await new Promise((resolve, reject) => {
                        chrome.runtime.sendMessage({ type: 'GET_SETTINGS' }, (response) => {
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve(response);
                            }
                        });
                        setTimeout(() => reject(new Error('超时')), 3000);
                    });
                    
                    if (response && response.settings) {
                        addCheckResult('✅', '扩展设置可用', 'success', `API提供商: ${response.settings.apiProvider || '未设置'}`);
                    } else {
                        addCheckResult('⚠️', '扩展设置异常', 'warning', '无法获取设置信息');
                    }
                } catch (error) {
                    addCheckResult('❌', '扩展设置获取失败', 'error', `错误: ${error.message}`);
                }
            } else {
                addCheckResult('❌', '无法测试扩展设置', 'error', '扩展API不可用');
            }

            // 检查5: Content Script
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    const response = await new Promise((resolve, reject) => {
                        chrome.runtime.sendMessage({ type: 'CHECK_CONTENT_SCRIPT' }, (response) => {
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve(response);
                            }
                        });
                        setTimeout(() => reject(new Error('超时')), 3000);
                    });
                    
                    addCheckResult('ℹ️', 'Content Script检查完成', 'info', 'Content Script将在需要时注入');
                } catch (error) {
                    addCheckResult('⚠️', 'Content Script检查失败', 'warning', '可能影响页面翻译功能');
                }
            } else {
                addCheckResult('❌', '无法检查Content Script', 'error', '扩展API不可用');
            }

            // 检查6: 权限
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                addCheckResult('ℹ️', '权限检查完成', 'info', '扩展具有必要的权限');
            } else {
                addCheckResult('❌', '无法检查权限', 'error', '扩展API不可用');
            }

            // 显示安装指南（如果有错误）
            if (hasErrors) {
                document.getElementById('installGuide').style.display = 'block';
            }
        }

        function openExtensionsPage() {
            if (typeof chrome !== 'undefined' && chrome.tabs) {
                chrome.tabs.create({ url: 'chrome://extensions/' });
            } else {
                window.open('chrome://extensions/', '_blank');
            }
        }

        function openTestPage() {
            window.open('test-extension-simple.html', '_blank');
        }

        // 页面加载时自动运行诊断
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 500);
        });
    </script>
</body>
</html>