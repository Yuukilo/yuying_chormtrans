name: Build and Release Chrome Extension

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        type: string

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run type check
        run: npm run check

      - name: Run tests
        run: npm test
        continue-on-error: true

  # æ„å»ºæ‰©å±•
  build:
    needs: lint-and-test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: ${{ steps.version.outputs.artifact-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact-name=yuying-translation-extension-v$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update manifest version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '$VERSION';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
            console.log('Updated manifest.json version to:', '$VERSION');
          "

      - name: Build extension
        run: npm run build

      - name: Create extension package
        run: |
          mkdir -p release
          cd dist
          zip -r ../release/${{ steps.version.outputs.artifact-name }}.zip .
          cd ..
          echo "Extension packaged as: ${{ steps.version.outputs.artifact-name }}.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact-name }}
          path: |
            release/${{ steps.version.outputs.artifact-name }}.zip
            dist/
          retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # åˆ›å»ºGitHub Releaseï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶ï¼‰
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "changelog=Initial release of Yuying Translation Extension" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆå˜æ›´æ—¥å¿—
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- (feat|fix|docs|style|refactor|perf|test|chore)" | head -20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="- Various improvements and bug fixes"
            fi
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "è¯­å½±ç¿»è¯‘æ’ä»¶ ${{ github.ref_name }}"
          body: |
            ## ğŸ‰ è¯­å½±ç¿»è¯‘æ’ä»¶ ${{ github.ref_name }} å‘å¸ƒ
            
            ### ğŸ“¦ å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½ä¸‹æ–¹çš„ `${{ needs.build.outputs.artifact-name }}.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            ### ğŸ”„ æ›´æ–°å†…å®¹
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ› ï¸ æŠ€æœ¯ä¿¡æ¯
            
            - **ç‰ˆæœ¬**: ${{ needs.build.outputs.version }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤**: ${{ github.sha }}
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            
            - Chrome 88+ æˆ–å…¶ä»–åŸºäºChromiumçš„æµè§ˆå™¨
            - éœ€è¦ç½‘ç»œè¿æ¥ä»¥ä½¿ç”¨ç¿»è¯‘API
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            
            å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤åé¦ˆã€‚
          files: |
            artifacts/release/${{ needs.build.outputs.artifact-name }}.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true

  # éƒ¨ç½²åˆ°GitHub Pagesï¼ˆå¯é€‰ï¼‰
  deploy-docs:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build documentation
        run: |
          mkdir -p _site
          cp -r docs/* _site/ 2>/dev/null || true
          cp README.md _site/index.md 2>/dev/null || true
          
          # åˆ›å»ºç®€å•çš„HTMLé¡µé¢
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>è¯­å½±ç¿»è¯‘æ’ä»¶</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  .header { text-align: center; margin-bottom: 40px; }
                  .download-btn { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px; }
                  .feature { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸŒ è¯­å½±ç¿»è¯‘æ’ä»¶</h1>
                  <p>æ™ºèƒ½ç½‘é¡µç¿»è¯‘Chromeæ‰©å±•</p>
                  <a href="https://github.com/${{ github.repository }}/releases/latest" class="download-btn">ğŸ“¥ ä¸‹è½½æœ€æ–°ç‰ˆæœ¬</a>
                  <a href="https://github.com/${{ github.repository }}" class="download-btn">ğŸ“š æŸ¥çœ‹æºç </a>
              </div>
              
              <div class="feature">
                  <h3>âœ¨ ä¸»è¦åŠŸèƒ½</h3>
                  <ul>
                      <li>ğŸ”„ æ™ºèƒ½ç½‘é¡µç¿»è¯‘</li>
                      <li>ğŸ–¼ï¸ OCRå›¾ç‰‡ç¿»è¯‘</li>
                      <li>ğŸ¯ å¤šç§ç¿»è¯‘APIæ”¯æŒ</li>
                      <li>âš¡ å¿«é€Ÿå“åº”å’Œç¼“å­˜</li>
                      <li>ğŸ¨ ç¾è§‚çš„ç”¨æˆ·ç•Œé¢</li>
                  </ul>
              </div>
              
              <div class="feature">
                  <h3>ğŸ“¦ å®‰è£…æ–¹æ³•</h3>
                  <ol>
                      <li>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„æ‰©å±•åŒ…</li>
                      <li>è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹</li>
                      <li>æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè¿›å…¥ chrome://extensions/</li>
                      <li>å¼€å¯"å¼€å‘è€…æ¨¡å¼"</li>
                      <li>ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹</li>
                  </ol>
              </div>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # é€šçŸ¥
  notify:
    if: always()
    needs: [lint-and-test, build, security-scan]
    runs-on: ubuntu-latest
    steps:
      - name: Notify on success
        if: needs.build.result == 'success'
        run: |
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
          echo "ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
          echo "æ„ä»¶: ${{ needs.build.outputs.artifact-name }}"

      - name: Notify on failure
        if: needs.build.result == 'failure' || needs.lint-and-test.result == 'failure'
        run: |
          echo "âŒ æ„å»ºå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚"
          exit 1